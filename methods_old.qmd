# Methodology {#sec-methods}

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(kableExtra)
```

This section lists our methodology.

<!-- We will compare models... -->

<!-- We will forecast several scenarios. -->

In order to compare trip-based and activity-based models, this research takes a specific model from both types to be representative.
The two models that this research compares are the \acr{WFRC} travel demand model (trip-based) and ActivitySim (activity-based).

## WFRC Model

The model is comprised of 5 main steps: household disaggregation, trip generation, trip distribution, mode choice, and network assignment.
Each of these steps has several sub-steps, and there are additional pre- and post-processing steps, but these five steps are the core of the model.
The household disaggregation model uses the land use and socioeconomic data (containing average household sizes, etc.) and estimates the number of households by type, meaning by number of residents and number of workers.
An additional part of this step is a vehicle ownership model, which further disaggregates the households by number of owned vehicles.
The remaining four steps proceed similarly to any other trip-based model, estimating trips from each household type by purpose, time of day, origin/destination, and mode choice, and assigning these trips to the network(s).

The final output(s) of the \acr{WFRC} model include network volumes and performance measures.
This includes loaded the network skims, which can then be used in subsequent iterations of the destination and mode choice models.
Additionally, the model outputs intermediate results after each main model step.
This includes disaggregated household data, trip generation estimates, and origin-destination matrices counting trips by purpose, mode, and time of day.

## ActivitySim

### Popsim

<!-- PopulationSim requires two main categories of inputs: a seed and controls. -->

<!-- The seed comes from XXXXX, and contains a sample of actual (anonymized) individuals and households in the Wasatch Front region. -->

<!-- PopulationSim assigns copies of these seeds to the area in a way that complies with the controls. -->

<!-- The controls contain targets for the synthetic population in categories such as number of households, **et al**. -->

<!-- For this we used a combination of the \acr{TAZ}-level socioeconomic data present in the \acr{WFRC} model and Census tract-level data. -->

## Initial Model Comparison

In order to reasonably compare the two models, the initial "baseline" scenarios in each should have relatively similar results.
Certainly this applies to the predicted trips by purpose, mode, length, etc., but it is also critical to ensure the synthetic population generated by PopulationSim matches the socioeconomic data used in the WFRC/MAG model.
The following sections discuss the efforts made to calibrate ActivitySim to the existing WFRC/MAG model.

### Socioeconomic data comparison

The WFRC/MAG model includes land use and socioeconomic data (both current and forecasted) for each TAZ.
As ActivitySim requires a synthetic population, the socioeconomic data is given at the individual level rather than the TAZ level.
However, the synthetic population should roughly match the aggregated data from the WFRC/MAG model so the models are at least somewhat comparable.

The synthetic population is tailored via regional targets or controls, which in this case are a combination of the socioeconomic data in the WFRC/MAG model and data from the U.S.
Census.
The data from both the Census and the WFRC/MAG model become geography-specific control totals which PopulationSim tries to match, with different weights assigned to each control.
Number of households, for example, was given at the TAZ level from the WFRC data and weighted very heavily, so there is no difference in number of households in each TAZ between the synthetic population and the WFRC data.
Total population, on the other hand, is a control from the Census data, and is in fact specified at the region geography level, and so there is some discrepancy between the synthetic population and the WFRC data (see @fig-totpop-comp).
However, these discrepancies are generally relatively minor, especially in more populated areas.

```{r}
#| label: fig-totpop-comp
#| fig-cap: Comparison of population by TAZ between WFRC data and PopulationSim synthetic population.
#| out-width: "100%"

targets::tar_read(pop_comp_map)
```

Another important comparison to make is of household income, as this can significantly affect travel behavior.
Instead of simply comparing average household income by TAZ, it is more useful to compare the number of households in each binned income group.
Both the WFRC and ActivitySim models use income *groups* as a variable in their model steps rather than the actual income.
The income groups for the WFRC model are given in @tbl-wfrc-income-groups.

```{r}
#| label: tbl-wfrc-income-groups
#| tbl-cap: income groups

targets::tar_read(income_groups) %>% 
  kbl(
    col.names = c("Income Group", "Income Range"),
    align = "c",
    booktabs = TRUE,
    linesep = ""
  ) %>% 
  kable_styling()
```

@fig-inc-groups-map shows a comparison of the number of households in each income group between the WFRC household disaggregation model and the synthetic population generated by PopulationSim.
There is a definite trend of the synthetic population to over-predict low-income households and over-predict high-income households compared to the WFRC disaggregation model.
However, especially since this research is focused more on a methodological comparison between the two models rather than a comparison of results, the discrepancies are not too severe to be concerned about.

```{r}
#| label: fig-inc-groups-map
#| fig-cap: income groups

targets::tar_read(inc_groups_map)
```

### Model output comparison

As with the socioeconomic comparisons between the models, trip patterns should somewhat agree between the WFRC/MAG model and ActivitySim.
This section discusses three types of comparisons between the outputs of the two models: mode split, \acr{TLFD}, and remote work.

The initial baseline ActivitySim scenario predicted a mode split significantly different to that from the WFRC/MAG model, and so calibration efforts were needed.
The most straightforward adjustments to make in ActivitySim's mode choice model are to the alternative-specific constants.
These were adjusted iteratively based on the difference in mode shares between the two models.
@tbl-mode-split compares the mode split of both models after several iterations of this calibration.
Overall, this calibration is okay, though there are still discrepancies (e.g. ActivitySim is predicting about twice as many transit trips as the WFRC/MAG model).
However, further adjustment of the constants would cause their values to become unreasonably large, as ActivitySim's mode split was converging at this point regardless of the ASC values (see @fig-calibration-plot).
This is likely due to the mode choice coefficients being unrepresentative of the study area.
The default ActivitySim configuration is based on San Francisco, and so coefficients on variables such as travel time will be optimized for that area (hence in part why there are so many more transit trips).

```{r}
#| label: tbl-mode-split
#| tbl-cap: mode split
#| cache: false

targets::tar_read(mode_split_comp) %>% 
  kbl(
    booktabs = TRUE,
    col.names = c("Purpose", "Mode", "ActivitySim predicted trips", "WFRC/MAG predicted trips", "% Error", "% Error (scaled to WFRC/MAG predicted trips)"),
    digits = c(0,0,0,0,1,1),
    align = "c"
  ) %>%
  kable_styling(latex_options = "scale_down") %>%
  column_spec(3, "3cm") %>%
  column_spec(4, "3.5cm") %>%
  column_spec(6, "3.7cm") %>%
  collapse_rows(1, valign = "middle", latex_hline = "major")
```

```{r}
#| label: fig-calibration-plot
#| fig-cap: calibration plot

targets::tar_read(calibration_plot)
```

@fig-tlfd-comp compares the trip length frequency distribution of the two models by mode and purpose.
Both ActivitySim and the WFRC/MAG model contain destination choice models which can be adjusted to affect the distribution of trip length.
However, as the figure shows, the two models have similar TLFDs, so no adjustment was necessary.
Again, the most significant discrepancies are with transit trips, likely due to the default "San Francisco" configuration of ActivitySim making transit more attractive.
Note that though these distributions match well enough for the purposes of this research, further calibration would be required to create a production-ready ActivitySim implementation.

```{r}
#| label: fig-tlfd-comp
#| fig-cap: tlfd comparison

targets::tar_read(tlfd_comp_plot)
```

The WFRC/MAG model has basic support for predicting telecommuting and work-from-home trips.
This includes a lookup table of telecommute percentages based on job type and year.
ActivitySim also has this functionality, and can additionally use individual- and household-level variables in its predictions.
The overall work-from-home and telecommute trip shares should be similar between the baseline scenarios in each model.
It is worth noting that both the WFRC/MAG model and ActivitySim make a distinction between "telecommuting", where an individual commutes to work some days and does not others, and "work-from-home" (or "home-based jobs" in the WFRC/MAG model), where an individual's workplace is always at their home.

Both models treat "work-from-home"/"home-based jobs" similarly.
The WFRC/MAG model's land use data contains employment by type in each TAZ, and it considers a "home-based job" as a separate job type, so these are not counted toward employment totals in trip generation and subsequent steps.
ActivitySim has a "work from home" submodel which assigns workers work-from-home status based on personal variables such as income, sex, and education (these were left unchanged from the default configuration).
There is also a "target work-from-home percent" value that adjusts the model to reach the specified work-from-home proportion of all workers.
Individuals with work-from-home status are then prohibited from making a mandatory tour.
@fig-wfrc-wfh shows the distribution of home-based job percentage by TAZ in the WFRC/MAG land use data.
A weighted average of `r targets::tar_read(wfrc_hbj_base_pct)` is taken to be the target percent value for ActivitySim, and there are no other adjustments to the ActivitySim work-from-home submodel.

```{r}
#| label: fig-wfrc-wfh
#| tbl-cap: wfrc wfh data

targets::tar_read(wfrc_hbj_base_plot)
```

The two models differ in their approach to telecommuting, however.
The WFRC/MAG model has a lookup table of telecommuting shares based on job type by year, including predictions for future years (see @tbl-wfrc-telecommute).
ActivitySim has a "telecommute frequency" submodel which assigns workers a telecommute status indicating the number of days they work remotely per week (1--4, since 5 days would be fully work-from-home).
Based on this status, the model adjusts the likelihood of making a mandatory tour.
Telecommute status depends on personal variables similar to those in the work-from-home submodel by default.
In order to calibrate to the WFRC/MAG data, however, we added job type variables to match those given in @tbl-wfrc-telecommute.
Because these are choice coefficients rather than target percentages, the values needed to be calibrated to match the WFRC/MAG targets.
However, each job type has a coefficient

```{r}
#| label: tbl-wfrc-telecommute
#| tbl-cap: wfrc telecommute data

targets::tar_read(wfrc_telecommute_table) %>% 
  mutate(across(
    c(wfrc_2019, wfrc_2050),
    \(x) scales::label_percent(accuracy = 0.01)(x))) %>% 
  kbl(
    booktabs = TRUE,
    align = "c",
    col.names = c("Job Type", "2019", "2050")
  ) %>% 
  add_header_above(c(" ", "WFRC/MAG Model Telecommute Proportion" = 2)) %>% 
  kable_styling()
```

## policy scenarios

We will model the following scenarios: - Land use - Transit - WFH

## Computational resources?

Describe BEAST and the BYU Supercomputer.
