# Methodology {#sec-methods}

```{r}
library(tidyverse)
library(ggspatial)
```


This section lists our methodology.

We will compare models...

We will forecast several scenarios.

## Models to Use

We are using the \acr{WFRC} regional travel demand model as a representative trip-based model.
This model is implemented in the CUBE software by Bentley (https://www.bentley.com/software/cube/, **fix into real citation**), and is currently used by \acr{WFRC} for modeling travel in the Salt Lake City, Utah area.
\acr{WFRC} provided the model directly, including land use forecasts and the current long-range transportation plan.
The model is taken mostly as-is, though some changes were made to better accommodate the different scenarios.
These modifications are noted in more detail in their respective sections.

Overview of WFRC model (inputs, outputs, etc)

The open-source ActivitySim [@cite] is used as our representative \acr{ABM}.
ActivitySim was developed....
Many agencies currently use a travel demand model based on ActivitySim in some form [@cite].
another sentence.

Overview of asim model (inputs, outputs, etc.) (also basic flowchart, tours/trips/etc)

We used PopulationSim [@cite] to create the synthetic population to use in ActivitySim.
PopulationSim requires two main categories of inputs: a seed and controls.
The seed comes from XXXXX, and contains a sample of actual (anonymized) individuals and households in the YYYYY region.
PopulationSim assigns copies of these seeds to the area in a way that complies with the controls.
The controls contain targets for the synthetic population in categories such as number of households, **et al**.
For this we used a combination of the \acr{TAZ}-level socioeconomic data present in the \acr{WFRC} model and Census tract-level data.

## Initial Model Comparison

In order to reasonably compare the two models, the initial "baseline" scenarios in each should have relatively similar results.
Certainly this applies to the predicted trips by purpose, mode, length, etc., but we also want to ensure the synthetic population generated by PopulationSim matches the socioeconomic data used in the WFRC model.
Though many controls such as ***household size and income group*** were specified from the Census at the tract level, the WFRC socioeconomic data contains this information as well.

Besides the different data sources, not all controls were weighted equally.
Number of households, for example, was given at the TAZ level from the WFRC data and weighted very heavily, so there is no difference in number of households in each TAZ between the synthetic population and the WFRC data.
Household *size*, on the other hand, is a control from the Census data, and so there is some discrepancy between the synthetic population and the WFRC data (see figure XXX).
However, these discrepancies are generally relatively minor, especially in more populated areas.

Another important comparison to make is of household income. (compare by group because of top-coding)

We are getting the input zonal SE data form the WFRC model and using that as targets for our synthetic population generation (via PopulationSim).

Enumerate and discuss model inputs/outputs (diagram?)

### Calibration check

```{r}
# Note the following for the WFRC OD matrices:
#auto = DA+SR2+SR3p
#dTRN = sum(d{trn})
#wTRN = sum(w{trn})
#transit = wTRN + dTRN
#motor = auto + transit + small error
#nonmotor = bike + walk + small error
```

We want to check if the ABM gives similar results to the WFRC model in the base scenario.
If not, then we can't really compare them.
They don't have to match exactly, but should be close.

#### synth pop

Show differences between the actual zonal SE data and the synthetic population data.
HH is the same since it was heavily weighted, but check some other things too, like avg income.

746 zones in the WFRC input data are listed as having no households.
Many of these make sense (Utah Lake, etc.).
Some in more urban areas may also make sense (commercial zoning, etc), but it's possible some are erroneous.
In any case, the synthetic population matches these targets, as we want the models to perform similarly to be able to make comparisons.

Many variables such as vehicle ownership were not given at the TAZ level in the input data (**were they given anywhere else?**).
This data is present in the synthetic population, but we can't compare it (**unless we find that data somewhere else**).

Overall we are pretty good; the vast majority of zones are within a doubling of the WFRC data in both persons and income.
There are some outliers, but they are fringe zones that are less populated anyway.

```{r}
#| echo: false
#| warning: false
#| message: false
#| error: false

# targets::tar_load(pop_comp)
# 
# pop_comp %>% 
#   filter(metric == "TOTHH") %>% 
#   ggplot() +
#   annotation_map_tile("cartolight", zoomin=1) +
#   geom_sf(aes(fill = diff), color = NA) +
#   scale_fill_binned() +
#   theme_void()
# 
# pop_comp %>% 
#   filter(metric == "TOTPOP") %>% 
#   ggplot() +
#   annotation_map_tile("cartolight", zoomin=1) +
#   geom_sf(aes(fill = diff), color = NA) +
#   scale_fill_gradient2() +
#   theme_void()
# 
# pop_comp %>% 
#   filter(str_detect(metric, "^INC")) %>% 
#   ggplot() +
#   annotation_map_tile("cartolight", zoomin=1) +
#   geom_sf(aes(fill = diff), color = NA) +
#   facet_wrap(~metric) +
#   scale_fill_gradient2(limits = c(-500,500)) +
#   # scale_fill_binned(type = "viridis", limits = c(-4.1,4.1)) +
#   theme_void() +
#   labs(title = "old")
  

# cowplot::plot_grid(plotlist = targets::tar_read(pop_comp_maps), nrow = 3)
```


#### TLFD

Compare TLFD, hopefully similar.

They are similar!
NOTE: The WFRC model multiplies trips by 100 in mode choice because there are a lot of fractional trips that would be lost to rounding otherwise.
We don't need to do that here (R can handle more than 2 decimal places), so we divided the trips by 100 to get the actual amount.

```{r}
#| echo: false

# targets::tar_read(combined_trips) %>%
#   group_by(model, mode, purpose) %>%
#   summarise(trips = sum(trips)) %>%
#   pivot_wider(names_from = model, values_from = trips) %>%
#   arrange(purpose, mode) %>%
#   mutate(error = asim/wfrc - 1) %>%
#   relocate(purpose)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| error: false

# targets::tar_read(combined_trips) %>% 
#   ggplot() +
#   geom_density(aes(x = distance, weight = trips, color = model)) +
#   facet_grid(
#     vars(mode), vars(purpose),
#     switch = "y",
#     scales = "free") +
#   xlim(0,25)
```



## policy scenarios

We will model the following scenarios:
- Land use
- Transit
- WFH

## Computational resources?

Describe BEAST and the BYU Supercomputer.
